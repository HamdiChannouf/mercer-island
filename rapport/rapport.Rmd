---
title: Analyse de Données
subtitle: Étude immobilière de l'île Mercer (Washington, USA)
author: Louie l'orang-outan
output:
   rmdformats::readthedown:
      highlight: kate
      self_contained: true
      df_print: kable
      toc_depth: 5
---

```{r, echo=FALSE}
library(knitr)
library(kableExtra)
options(knitr.table.format = "html")
opts_chunk$set(warning=FALSE,
               echo=FALSE,
               message=FALSE,
               fig.align="center")
```

```{r}
library(tidyverse)
library(cowplot)
library(rgdal)
library(corrplot)
library(ineq)
library(bsselectR)
library(viridis)
```

```{r}
D <- read.csv("../donnees/kc_house_data.csv")


D$date <- as.Date(sapply(as.character(D$date), function(x){ paste(substr(x, 0, 4), substr(x, 5, 6), substr(x, 7, 8), sep = "-") }, USE.NAMES = F))

## transformation des variables
## 
D$yr_built <- as.Date(paste(D$yr_built, "01-01", sep = "-"))
#D$yr_renovated 
D$yr_renovated <- as.Date(ifelse(D$yr_renovated==0, NA, paste(D$yr_renovated, "01-01", sep="-")))

D$zipcode <- as.factor(D$zipcode)
D$waterfront <- as.factor(D$waterfront)
D$grade <- factor(D$grade)
D$condition <- factor(D$condition)

M <- filter(D, zipcode == 98040)
```

## Introduction

Nous allons étudier un jeu de données immobilières. Il s'agit des ventes de logements à King County, compté contenant la ville de Seattle aux États-Unis. Ce jeu de donnée a été utilisé par un cours Coursera, il semblait tout à fait convenir à une introduction à diverses techniques de l'analyse et traitement de données, sachant l'extreme diversité des méthodes à utiliser, même pour des données modestes. Parmi les avantages de cet ensemble de données, déjà mise en forme, pas d'imputation de données nécessaires, peu de facteurs, une application possible d'une régression linéaire sans être obligé d'utiliser des modèles complexes.

L'objectif de ce projet est d'analyser l'ensemble de donnée avant de faire une modélisation par régression linéaire, cette analyse est une étape indispensable pour développer une intuition sur l'ensemble de données, et donc la création de modèle.

### Variables du jeu de données

Les données correspondent aux logements vendus entre mai 2014 et mai 2015. Un logement est constitué d'une surface habitable et d'un terrain. À chacun de ces logements sont associés les 21 variables suivantes: 

id
:   Identifiant du logement (ignoré pour l'analyse) 

date
:   Date de vente du logement [Date]

price
:   Prix de vente [Continu]

bedrooms
:   Nombre de chambres [Discret]

bathrooms
:   Ratio entre le nombre de salle de bain et de chambre

sqft-living
:   Surface du logement (somme du sous-sol et étages supérieurs) [Continu]

sqft-above
:   Surface du logement située au dessus du sol [Continu]

sqft-basement
:   Surface du logement au niveau du sous-sol [Continu]

sqft-lot
:   Surface du terrain [Continu]

floors
:   Nombre d'étages dans la maison [Discret]

waterfront
:   Vue sur les quais [Binaire]

view
:   Nombre de fois le logement a été visité [Discret]

condition
:   Appréciation de l'état du logement [Factoriel]

grade
:   Évaluation de la qualité de construction du logement [Factoriel]

yr-built
:   Année de construction [Date]

yr-renovated
:   Année de rénovation [Date]

zipcode
:   Zipcode

lat
:   Lattitude [Coordonnées]

long
:   Longitude [Coordonnées]

sqft-living2015
:   Surface du logement en 2015 [Continu]

sqft-lot2015
:   Surface du terrain en 2015 [Continu]

Petite précision sur le facteur grade. Ce facteur est directement issu de l'administration de King County, en particulier pour la collecte d'impots. Elle établit une classification de 1 à 13 des logements de King County en fonction de la finition du logement. Cela permet d'avoir une vague idée sur la valeur du logement en tant qu'édifice. Il y a donc un ordre entre les niveaux de ce facteur. Néanmoins, ce facteur ne doit pas être pris comme une valeur entièrement objective, car il peut s'agir d'une estimation.

* [1-3] Ne convient presque pas aux standard de construction. A priori une cabane.
* [4] Généralement un édifice de mauvaise qualité ayant vielli. Ne rentre pas dans les standards.
* [5] Peu cher et peu travaillé. Petit et simple.
* [6] Plus petite catégorie qui est aux normes. Matériaux de mauvaise qualité, simplicité.
* [7] Construction normale que l'on rencontre sur un terrain habité.
* [8] Construction un peu mieux que la moyenne. Meilleurs matériaux dans les finitions.
* [9] Meilleure architecture, de bonnes conception et qualité d'éxécution.
* [10] Les habitations de ce type sont celles de qualité supérieure, meilleur finition, plus spacieuse et un meilleur agencement des pièces
* [11] Conception personnalisée et finitions de qualité supérieure, avec ajout de mobilier en bois massif, de mobiliers fixatif dans les salles de bains et agréments de luxe.
* [12] Conception personnalisée et excellents éxécutants. Tous les matériaux sont de qualités supérieurs, et toutes les commodités sont présentes
* [13] Généralement, conception et construction personalisées. Proche du niveau du manoir. Important travail pour les cuisines. Grande quantité de plancher en bois et de marbre. Grandes entrées.

### Restriction à Mercer Island

L'île Mercer fait partie des 100  unités territoriales les plus riches de l'état de Washington. Elle est reliée à la terre qui l'entoure par une voie routière la traversant. On peut l'étudier comme un microsome étant donné le lac qui la sépare de la terre. Comparé à Vashon Island qui ne possède pas de liason terrestre, elle est dynamique et urbanisée.Au sein du jeu de données complet, on peut noter de très grandes disparités territoriales qui ont un impact direct sur le type d'habitation et leurs valeurs. En choisissant un ensemble géographiquement homogène et bien plus petit, on espère pouvoir avoir des conclusions plus précises et faciles à découvrir. 
Cela doit être vu comme une première étape à l'analyse du jeu de données complet, que l'on ne peut pas mener à cause de contraintes temporelles et manque d'expérience.

## Sommaire
### Variables continues
```{r}
sommaire <- sapply(select(M, -c(id, grade, condition, zipcode, waterfront, date, yr_built, yr_renovated, bedrooms, view)), summary)

rownames(sommaire) <- c("Minimum",
                        "1er Quartile",
                        "Médiane",
                        "Moyenne",
                        "3e Quartile",
                        "Maximum")


t(sommaire) %>% kable %>%
    kable_styling("striped", full_width = F)

```

### Variables factorielles ou discrètes
```{r}
som_fod <- function(x) {
    x %>% as.factor %>% summary %>%
        (function(x){c(Valeurs = "Décompte", x)}) %>%
        as.matrix %>%
        t %>%
        kable %>%
        kable_styling("striped", full_width = F) %>%
        row_spec(0,  bold = T)
}
```

#### bedrooms
```{r}
som_fod(M$bedrooms)

```

#### view
```{r}
som_fod(M$view)

```

#### grade 
```{r}
som_fod(M$grade)

```

#### condition
```{r}
som_fod(M$condition)

```

#### waterfront
```{r}
som_fod(M$waterfront)

```

### Variables temporelles
#### Sans valeurs manquantes
```{r}
sommaire_tmp <- sapply(select(M, yr_built, date), summary)

sommaire_tmp <- as.data.frame(sommaire_tmp) %>% mutate_all(function(x){as.Date(x, origin="1970-01-01")}) 


rownames(sommaire_tmp) <- c("Minimum",
                        "1er Quartile",
                        "Médiane",
                        "Moyenne",
                        "3e Quartile",
                        "Maximum")


t(sommaire_tmp) %>% kable %>%
    kable_styling("striped", full_width = F)
```

#### Avec valeurs manquantes
```{r}
M$yr_renovated %>% summary %>% as.character %>% as.matrix %>%
    (function(x) { rownames(x) <- c("Minimum",
                        "1er Quartile",
                        "Médiane",
                        "Moyenne",
                        "3e Quartile",
                        "Maximum",
                        "Valeurs Manquantes");
                        colnames(x) <- c("yr_renovated");
                        x}) %>% t %>%
    kable %>%
    kable_styling("striped", full_width = F)


```


## Répartition géographique

```{r, results="hide"}
map_king_county <- readOGR(dsn="../donnees/map", layer="Zipcodes_for_King_County_and_Surrounding_Area_Shorelines__zipcode_shore_area")
map_mercer <- subset(map_king_county, ZIPCODE == "98040")

pts <- SpatialPointsDataFrame(select(M, long, lat),
                              select(M, -c(long, lat)),
                              proj4string=CRS(proj4string(map_mercer)))
```

```{r}
map_plot <- ggplot(map_mercer, aes(x=long, y=lat)) + geom_polygon(fill="grey50") + theme(legend.position = "bottom", legend.key.width = unit(1, "cm")) +  coord_fixed()

```

```{r}
map_elements <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat),shape=23, size=2, alpha=0.5, fill="red")
```

```{r}
map_sqft_living15 <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=(sqft_living15)^0.5) ,shape=23, size=2, alpha=0.5) + scale_fill_viridis()


map_sqft_living <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=(sqft_living)^0.5) ,shape=23, size=2, alpha=0.5) + scale_fill_viridis()
```

```{r}
map_sqft_lot15 <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=(sqft_lot15)^0.5) ,shape=23, size=2, alpha=0.5) + scale_fill_viridis()

map_sqft_lot <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=(sqft_lot)^0.5), shape=23, size=2, alpha=0.5) + scale_fill_viridis()
```

```{r}
map_sqft_above <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=(sqft_above)^0.5) ,shape=23, size=2, alpha=0.5) + scale_fill_viridis()
```

```{r}
map_sqft_basement_not_null <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=sqft_basement>0), shape=23, size=2, alpha=0.5) +
    scale_fill_manual(values=c("grey30", "red"))

map_sqft_basement <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=(sqft_basement)^0.5), shape=23, size=2, alpha=0.5) +
    scale_shape_identity() +
    scale_fill_viridis()
```

```{r}
map_floors <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=floors) ,shape=23, size=2, alpha=0.5) + scale_fill_viridis()
```

```{r}
map_bedrooms <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=bedrooms) ,shape=23, size=2, alpha=0.5) + scale_fill_viridis()
```

```{r}
map_bathrooms <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=bathrooms) ,shape=23, size=2, alpha=0.5) + scale_fill_viridis()
```

```{r}
map_grade <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=grade) ,shape=23, size=2, alpha=0.5) + scale_color_brewer(palette = "Set1")

map_condition <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=condition) ,shape=23, size=2, alpha=0.5) + scale_color_brewer(palette = "Set1")
```

```{r}
map_yr_built <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=as.integer(yr_built)) ,shape=23, size=2, alpha=0.5) + scale_fill_viridis(name = "Date", labels=function(x) { format(as.Date(x, origin='1970-01-01'), "%Y")})

map_renovated <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=!is.na(yr_renovated)) ,shape=23, size=2, alpha=0.5) +
    scale_fill_manual(name = "Renovated", values=c("grey30", "red"))

map_yr_renovated <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=as.integer(yr_renovated)) ,shape=23, size=2, alpha=0.5) +
    scale_fill_viridis(name = "Date", labels=function(x) { format(as.Date(x, origin='1970-01-01'), "%Y")})

```

```{r}
map_waterfront <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=waterfront) ,shape=23, size=2, alpha=0.5) +
    scale_fill_manual(values=c("grey30", "red"))
```

```{r}
map_logprice <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=log10(price)) ,shape=23, size=2, alpha=0.5) + scale_fill_viridis()
```

```{r}
map_date <- map_plot + geom_point(data=as.data.frame(pts), aes(long, lat, fill=as.integer(date)), shape=23, size=2, alpha=0.5) +
    scale_shape_identity() +
    scale_fill_viridis(name = "Date", labels=function(x) { format(as.Date(x, origin='1970-01-01'), "%B")}) +
    theme(legend.text=element_text(size=8))

```

```{r}
menu_map <- list(map_elements,
                 map_sqft_living15,
                 map_sqft_living,
                 map_sqft_lot15,
                 map_sqft_lot,
                 map_sqft_above,
                 map_sqft_basement_not_null,
                 map_sqft_basement,
                 map_floors,
                 map_bedrooms,
                 map_bathrooms,
                 map_grade,
                 map_condition,
                 map_yr_built,
                 map_renovated,
                 map_yr_renovated,
                 map_waterfront,
                 map_logprice,
                 map_date)

menu_map_filename <- c("map_elements",
                       "map_sqft_living15",
                       "map_sqft_living",
                       "map_sqft_lot15",
                       "map_sqft_lot",
                       "map_sqft_above",
                       "map_sqft_basement_not_null",
                       "map_sqft_basement",
                       "map_floors",
                       "map_bedrooms",
                       "map_bathrooms",
                       "map_grade",
                       "map_condition",
                       "map_yr_built",
                       "map_renovated",
                       "map_yr_renovated",
                       "map_waterfront",
                       "map_logprice",
                       "map_date")

menu_map_filename <- paste0(menu_map_filename, ".png")

pwalk(list(menu_map_filename, menu_map), ggsave, path = "plots", dpi = 300, height = 6)

menu_map_name <- c("Logements",
                   "Surface habitable en 2015",
                   "Surface habitable",
                   "Surface du terrain en 2015",
                   "Surface du terrain",
                   "Surface des étages au dessus du sol",
                   "Présence d'un sous-sol",
                   "Surface du sous-sol",
                   "Nombre d'étages",
                   "Nombre de chambres à coucher",
                   "Ratio salles de bain sur chambres à coucher",
                   "Grade",
                   "Condition",
                   "Année de construction",
                   "Rénovation entreprise",
                   "Année de rénovation",
                   "Vue sur les quais",
                   "Prix en échelle log",
                   "Date de vente")

list_menu_map_file <- paste0("plots/", menu_map_filename)
names(list_menu_map_file) <- menu_map_name

bsselect(list_menu_map_file,
         type = "img",
         live_search = TRUE,
         show_tick = TRUE,
         width=0, height=0)
```

## Inégalités
```{r affiche-lorentz}
affiche_lorentz <- function(v)
{
    sqft_living_G <- ineq(v)
    ggplot(data.frame(lp=seq(length(v))/length(v),
                      cp=cumsum(sort(v))/sum(v)),
           aes(lp)) +
        geom_line(aes(lp, cp), col="red", lty="dashed", size=1.2) +
        geom_ribbon(aes(ymin=cp, ymax=lp), fill="yellow") +
        geom_segment(aes(x=0, y=0, xend=1, yend=1), col="red", lty="dashed") +
        xlim(0, 1) +
        xlab("Pourcentage de la population") +
        ylab("Richesse cumulée") +
        annotate("text", x=0.25, y=0.775, label=paste("italic(G) ==", round(sqft_living_G, 2)), parse=TRUE, size=10)
}
```
### Valeur
```{r}
plot_grid(
    ggplot(M, aes(log10(price))) + geom_histogram(bins=30),
    affiche_lorentz(M$price)
    )
```

### Surface habitée

#### Antérieurement à 2015
```{r}
plot_grid(
    ggplot(M, aes((sqft_living)^0.5)) + geom_histogram(bins=30),
    affiche_lorentz(M$sqft_living)
    )
```

#### En 2015
```{r}
plot_grid(
    ggplot(M, aes((sqft_living15)^0.5)) + geom_histogram(bins=30),
    affiche_lorentz(M$sqft_living15)
)
```

### Surface terrain
#### Antérieurement à 2015
```{r}
plot_grid(
    ggplot(M, aes((sqft_lot)^0.5)) + geom_histogram(bins=30),
    affiche_lorentz(M$sqft_lot)
)
```

#### En 2015
```{r}
plot_grid(
    ggplot(M, aes((sqft_lot15)^0.5)) + geom_histogram(bins=30),
    affiche_lorentz(M$sqft_lot15)
)
```

## Corrélation linéaire
```{r}
corrplot(cor(M %>% select(-c(view, condition, grade, 
                          lat, long, 
                          date, yr_built, yr_renovated,
                          id, 
                          zipcode, 
                          waterfront)) %>%
             mutate(logPrice = log10(price)) %>%
             select(-price)),
         type="upper", order="hclust", addCoef.col="black")
```

## Réaménagements
### Surface Habitable
```{r}
#M %>% ggplot() + geom_point(aes(sqft_living, sqft_living15))
M %>% ggplot() + geom_histogram(aes((sqft_living15 - sqft_living)/sqft_living))

plot_grid(
    M %>% ggplot() + geom_point(aes(sqft_living , (sqft_living15 - sqft_living)/sqft_living), alpha=0.5) + ggtitle("Absolu"),
    M %>% ggplot() + geom_point(aes(sqft_living , (sqft_living15 - sqft_living)), alpha=0.5) + ggtitle("Relatif")
)

```

### Surface du terrain
```{r}
# Rien à faire ici
# M %>% ggplot() + geom_point(aes(sqft_lot15, sqft_living15))
# M %>% ggplot() + geom_point(aes(sqft_lot, sqft_living))

M %>% ggplot() + geom_histogram(aes((sqft_lot15 - sqft_lot)/sqft_lot))
plot_grid(
    M %>% ggplot() + geom_point(aes(sqft_lot , (sqft_lot15 - sqft_lot)/sqft_lot), alpha=0.5) + ggtitle("Absolu"),
    M %>% ggplot() + geom_point(aes(sqft_lot , (sqft_lot15 - sqft_lot)), alpha=0.5) + ggtitle("Relatif")
)
```

### Lien entre aménagement de la surface intérieure et extérieure
```{r}
plot_grid(
    M %>% ggplot() + geom_point(aes((sqft_living15 - sqft_living)/sqft_living ,(sqft_lot15 - sqft_lot)/sqft_lot), alpha=0.5) + geom_abline(slope = 1, color="red") + coord_fixed() + ggtitle("Absolu"),
    M %>% ggplot() + geom_point(aes((sqft_living15 - sqft_living),(sqft_lot15 - sqft_lot)/10), alpha=0.5) + geom_abline(slope = 1, color="red") + ggtitle("Relatif")
)
```

### Lien entre aménagement de la surface intérieure et surface initiale du terrain
```{r}
plot_grid(
    M %>% ggplot() + geom_point(aes(sqft_lot , (sqft_living15 - sqft_living)/sqft_living), alpha=0.5) + ggtitle("Absolu"),
    M %>% ggplot() + geom_point(aes(sqft_lot , (sqft_living15 - sqft_living)), alpha=0.5) + ggtitle("Relatif")
)
```

### Harmonisation de la surface intérieure et la surface extérieure

```{r}
plot_grid(
    M %>% ggplot() + geom_point(aes(sqft_living, sqft_lot)),
    M %>% ggplot() + geom_point(aes(sqft_living15, sqft_lot15))
)
```

## Impact des caractéristiques du logement sur le prix
### Surface habitable
#### En 2015
```{r}
M %>% ggplot() + geom_point(aes(sqft_living15, log10(price)))
```

#### Avant 2015
```{r}
M %>% ggplot() + geom_point(aes(sqft_living, log10(price)))
```

### Surface du terrain
#### En 2015
```{r}
M %>% ggplot() + geom_point(aes(sqft_lot15, log10(price)))
```

#### Avant 2015
```{r}
M %>% ggplot() + geom_point(aes(sqft_lot, log10(price)))
```

### Utilitaires
#### Salles de bain
```{r}
M %>% ggplot() + geom_point(aes(bathrooms, log10(price)))
```

#### Salles à coucher
```{r}
M %>% ggplot() + geom_boxplot(aes(factor(bedrooms), price))
```

### Audit
#### Grade
```{r}
M %>% ggplot() + geom_boxplot(aes(grade, price))
```

#### Condition
```{r}
M %>% ggplot() + geom_boxplot(aes(condition, price))

```

### Temps
#### Année de construction
```{r}
M %>% ggplot()+ geom_point(aes(yr_built, log10(price)))
```

#### Année de rénovation
```{r}
M %>% ggplot()+ geom_point(aes(yr_renovated, log10(price)))
```

#### Date de vente
```{r}
M %>% ggplot()+ geom_boxplot(aes(cut(date, "month"), log10(price)))
```

### Réaménagements
#### Surface habitable
```{r}
price_ream_living_w_legend<- M %>% ggplot() + geom_point(aes(sqft_living, log10(price),
                                                     color=cut((sqft_living15 - sqft_living)/sqft_living,
                                                               breaks=c(-Inf,
                                                                        -1,
                                                                        -0.5,
                                                                        -0.1,
                                                                        0.1,
                                                                        0.5,
                                                                        1,
                                                                        Inf)
                                                               )),
                                                     alpha = 0.5) +
    scale_color_brewer(palette = "Set1", guide = guide_legend(title = "Aménagement\nabsolu"))

price_ream_living <- price_ream_living_w_legend+ theme(legend.position="none")

price_ream_living15 <-     M %>% ggplot() + geom_point(aes(sqft_living15, log10(price),
                                    color=cut((sqft_living15 - sqft_living)/sqft_living,
                                              breaks=c(-Inf,
                                                       -1,
                                                       -0.5,
                                                       -0.1,
                                                       0.1,
                                                       0.5,
                                                       1,
                                                       Inf)
                                              )),
                                    alpha = 0.5) +
    scale_color_brewer(palette = "Set1") + theme(legend.position="none")

plot_grid(price_ream_living, price_ream_living15,get_legend(price_ream_living_w_legend), nrow=1, hjust = -1, rel_widths = c(2, 2, .5))
```

#### Surface du terrain
```{r}
price_ream_lot_w_legend <- M %>% filter(sqft_lot < 75000) %>% ggplot() + geom_point(aes(sqft_lot, log10(price),
                                                     color=cut((sqft_lot15 - sqft_lot)/sqft_lot,
                                                               breaks=c(-Inf,
                                                                        -1,
                                                                        -0.5,
                                                                        -0.1,
                                                                        0.1,
                                                                        0.5,
                                                                        1,
                                                                        Inf)
                                                               )),
                                                     alpha = 0.5) +
    scale_color_brewer(palette = "Set1", guide = guide_legend(title = "Aménagement\nabsolu", title.hjust = 0.3)) 

price_ream_lot <- price_ream_lot_w_legend+ theme(legend.position="none")

price_ream_lot15 <- M %>% ggplot() + geom_point(aes(sqft_lot15, log10(price),
                                    color=cut((sqft_lot15 - sqft_lot)/sqft_lot,
                                              breaks=c(-Inf,
                                                       -1,
                                                       -0.5,
                                                       -0.1,
                                                       0.1,
                                                       0.5,
                                                       1,
                                                       Inf)
                                              )),
                                    alpha = 0.5) +
    scale_color_brewer(palette = "Set1") + theme(legend.position="none")

plot_grid(price_ream_lot, price_ream_lot15,get_legend(price_ream_lot_w_legend), nrow=1, hjust = -1, rel_widths = c(2, 2, .5))
```

Une valeur anormalement grande a été retiré du premier graphe en raison d'une valeur de $sqft\_lot$ très éloignée du nuage (supérieur à 75000).


## Autres
```{r}
M %>% ggplot() + geom_boxplot(aes(factor(bedrooms), bathrooms))


plot_grid(
    M %>% ggplot() + geom_boxplot(aes(factor(bedrooms), sqft_living15)),
    M %>% ggplot() + geom_boxplot(aes(factor(bedrooms), sqft_living))
)

plot_grid(
    M %>% ggplot() + geom_boxplot(aes(grade, sqft_living15)),
    M %>% ggplot() + geom_boxplot(aes(grade, sqft_living))
)



plot_grid(
    M %>% ggplot() + geom_boxplot(aes(grade, sqft_lot15)),
    M %>% ggplot() + geom_boxplot(aes(grade, sqft_lot))
)

plot_grid(
    M %>% ggplot() + geom_boxplot(aes(condition, sqft_living15)),
    M %>% ggplot() + geom_boxplot(aes(condition, sqft_living))
)


M %>% ggplot()+ geom_point(aes(yr_built, yr_renovated))
```

```{r}
regression <- (lm(log(price)~sqft_living+sqft_living15+sqft_basement+bathrooms+waterfront+view, M))
summary(regression)
```

```{r}
outliers <- (abs(regression$residuals) > 0.4)
ggplot(regression) + geom_point(aes(regression$fitted.values, regression$residuals, color=outliers))


map_plot + geom_point(data=filter(M, outliers), aes(long, lat), color="red")
```

```{r}
regression_no <- lm(log(price)~sqft_living+sqft_living15+sqft_basement+bathrooms+waterfront+view, M %>% filter(!outliers))
summary(regression_no)
```

```{r}
regression_test <- lm(log(price)~sqft_living+sqft_living15+sqft_basement+bathrooms+waterfront+view+yr_built, M %>% filter(!outliers))
summary(regression_test)
```

